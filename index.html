<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Auditor√≠a Lean Construction</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #ffffff;
      color: #1d1d1f;
      text-align: center;
    }

    /* SPLASH INICIAL */
    #splashInicial {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #0f4c75, #3282b8, #bbe1fa);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      z-index: 1000;
    }

    #splashInicial h1 {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    #splashInicial .empresa {
      font-size: 24px;
      font-weight: 400;
      margin-bottom: 30px;
      opacity: 0.9;
    }

    #splashInicial .version {
      position: absolute;
      bottom: 30px;
      font-size: 14px;
      opacity: 0.9;
      color: rgba(255, 255, 255, 0.9);
    }

    .screen {
      display: none;
      min-height: 100vh;
      padding: 60px 20px;
      box-sizing: border-box;
    }

    .active {
      display: block;
    }

    h1 {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    h2 {
      font-size: 22px;
      font-weight: 400;
      color: #6e6e73;
      margin-bottom: 40px;
    }

    button {
      background-color: #0071e3;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 24px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #005bb5;
    }

    button.secondary {
      background-color: #e5e5ea;
      color: #000;
    }

    button.secondary:hover {
      background-color: #d1d1d6;
    }

    form {
      max-width: 600px;
      margin: auto;
      text-align: left;
    }

    label {
      font-weight: 500;
      display: block;
      margin-top: 20px;
    }

    select {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #d2d2d7;
      font-size: 15px;
    }

    .success {
      color: #0071e3;
      font-size: 18px;
      margin-top: 20px;
    }

    .back-button {
      background-color: #e5e5ea;
      color: #000;
      margin-bottom: 30px;
    }

    .back-button:hover {
      background-color: #d1d1d6;
    }

    /* ESTILOS PARA LA B√öSQUEDA DE PROYECTOS */
    .search-container {
      max-width: 600px;
      margin: 0 auto 30px auto;
    }

    .search-input {
      width: 100%;
      padding: 14px 20px;
      border-radius: 10px;
      border: 1px solid #d2d2d7;
      font-size: 16px;
      box-sizing: border-box;
    }

    .search-input:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    /* ESTILOS PARA LAS TARJETAS DE PROYECTOS */
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: 0 auto 40px auto;
    }

    .project-card {
      background-color: #f5f5f7;
      border-radius: 12px;
      padding: 25px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .project-card:hover {
      background-color: #e8e8ed;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .project-card.selected {
      background-color: #0071e3;
      color: white;
      border-color: #005bb5;
    }

    .project-card.hidden {
      display: none;
    }

    .project-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .project-sucursal {
      font-size: 14px;
      color: #666;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 4px 10px;
      border-radius: 20px;
      display: inline-block;
      margin-top: 5px;
    }

    .project-card.selected .project-sucursal {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .no-results {
      grid-column: 1 / -1;
      padding: 40px;
      color: #666;
      font-size: 18px;
    }

    .select-button {
      margin-top: 20px;
      width: auto;
      min-width: 200px;
    }

    /* NUEVOS ESTILOS PARA EVALUACI√ìN DE ASISTENCIA */
    .asistencia-container {
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
    }

    .tipo-reunion-info {
      background-color: #f0f8ff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      border-left: 4px solid #0071e3;
    }

    .participante-item {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #e5e5ea;
    }

    .participante-info {
      flex: 1;
    }

    .participante-nombre {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .participante-peso {
      color: #666;
      font-size: 14px;
    }

    .asistencia-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .asistencia-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .total-asistencia {
      background-color: #0071e3;
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-top: 30px;
      text-align: center;
    }

    .total-porcentaje {
      font-size: 36px;
      font-weight: 700;
      margin: 10px 0;
    }

    .contratistas-container {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff8e1;
      border-radius: 8px;
      border: 1px solid #ffd54f;
    }

    .contratista-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .contratista-item:last-child {
      border-bottom: none;
    }

    .nota-info {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>

<body>

<!-- SPLASH INICIAL (Nuevo) -->
<div id="splashInicial">
  <h1>Madurez Lean Construction</h1>
  <div class="empresa">MARVAL S.A.</div>
  <div class="version">Formulario Lean Versi√≥n 1.2</div>
</div>

<!-- SPLASH (Original) -->
<div id="splash" class="screen">
  <h1>Auditor√≠a Lean Construction</h1>
  <h2>Evaluaci√≥n del nivel de madurez en obra</h2>
  <button onclick="mostrarResponsables()">Iniciar auditor√≠a</button>
</div>

<!-- SELECCI√ìN RESPONSABLE -->
<div id="responsables" class="screen">
  <h1>Seleccione el responsable</h1>

  <button onclick="seleccionarResponsable('Direcci√≥n Nacional')">
    Direcci√≥n Nacional
  </button>

  <button onclick="seleccionarResponsable('Sucursal Bogot√°')">
    Sucursal Bogot√°
  </button>

  <button onclick="seleccionarResponsable('Sucursal Bucaramanga')">
    Sucursal Bucaramanga
  </button>

  <button onclick="seleccionarResponsable('Sucursal Costa')">
    Sucursal Costa
  </button>
</div>

<!-- SELECCI√ìN DE PROYECTO -->
<div id="proyectosScreen" class="screen">
  <h1 id="bienvenidaResponsable"></h1>
  <h2>Seleccione el proyecto a auditar</h2>
  
  <div class="search-container">
    <input type="text" 
           id="buscadorProyectos" 
           class="search-input" 
           placeholder="üîç Buscar proyecto por nombre..."
           onkeyup="filtrarProyectos()">
  </div>
  
  <div class="projects-grid" id="listaProyectos"></div>
  
  <div id="proyectoSeleccionadoContainer" style="display: none;">
    <button class="select-button" onclick="confirmarProyecto()">Seleccionar Proyecto</button>
  </div>
  
  <button class="back-button" onclick="volverAResponsables()">‚Üê Volver a selecci√≥n de responsable</button>
</div>

<!-- NUEVA PANTALLA: SELECCI√ìN DE TIPO DE REUNI√ìN -->
<div id="tipoReunionScreen" class="screen">
  <h1 id="bienvenidaTipoReunion"></h1>
  <h2 id="infoProyectoTipoReunion"></h2>

  <div class="tipo-reunion-info">
    <h3>Seleccione el tipo de reuni√≥n a auditar</h3>
    <p>Esta selecci√≥n determinar√° el sistema de evaluaci√≥n de asistencia</p>
  </div>

  <div style="max-width: 400px; margin: 40px auto;">
    <button style="width: 100%; margin-bottom: 20px; padding: 20px; font-size: 18px;" onclick="seleccionarTipoReunion('Intermedia - Equipo Administrativo')">
      üìä Reuni√≥n Intermedia<br>
      <small>Equipo Administrativo</small>
    </button>

    <button style="width: 100%; padding: 20px; font-size: 18px;" onclick="seleccionarTipoReunion('Semanal - Contratistas y Obra')">
      üìã Reuni√≥n Semanal<br>
      <small>Contratistas / Directores / Residentes</small>
    </button>
  </div>

  <button class="back-button" onclick="volverAProyectosDesdeTipoReunion()">‚Üê Volver a selecci√≥n de proyecto</button>
</div>

<!-- NUEVA PANTALLA: EVALUACI√ìN DE ASISTENCIA -->
<div id="asistenciaScreen" class="screen">
  <h1 id="tituloAsistencia"></h1>
  <h2 id="subtituloAsistencia"></h2>

  <div class="asistencia-container" id="contenedorAsistencia">
    <!-- El contenido se genera din√°micamente seg√∫n el tipo de reuni√≥n -->
  </div>

  <button id="btnContinuarAsistencia" style="margin-top: 30px;" onclick="continuarAFormulario()" disabled>
    Continuar al formulario principal
  </button>
  
  <button class="back-button" onclick="volverATipoReunion()">‚Üê Volver a selecci√≥n de tipo de reuni√≥n</button>
</div>

<!-- FORMULARIO COMPLETO -->
<div id="formularioScreen" class="screen">
  <h1 id="bienvenidaCompleta"></h1>
  <h2 id="infoProyecto"></h2>

  <form id="formAuditoria">
    <label>Proyecto seleccionado</label>
    <select name="proyecto" id="proyectoSelect" required disabled>
      <option value="" id="proyectoSeleccionadoOption"></option>
    </select>

    <label>Tipo de reuni√≥n evaluada</label>
    <select name="tipoReunion" id="tipoReunionSelect" required disabled>
      <option value="" id="tipoReunionSeleccionadaOption"></option>
    </select>

    <label>Asistencia calculada</label>
    <input type="text" name="asistenciaCalculada" id="asistenciaCalculadaInput" readonly style="width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #d2d2d7; background-color: #f5f5f7; font-size: 15px;">

    <label>Nivel de cumplimiento Lean observado</label>
    <select name="nivelMadurez" required>
      <option value="">Seleccione una opci√≥n</option>
      <option value="Inicial">Inicial</option>
      <option value="En desarrollo">En desarrollo</option>
      <option value="Estandarizado">Estandarizado</option>
      <option value="Optimizado">Optimizado</option>
    </select>

    <label>Observaciones adicionales (opcional)</label>
    <textarea name="observaciones" rows="3" placeholder="Agregue observaciones relevantes sobre la auditor√≠a" style="width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #d2d2d7; font-size: 15px; font-family: inherit;"></textarea>

    <button type="submit" style="margin-top:30px;">Guardar auditor√≠a</button>
  </form>

  <button class="back-button" onclick="volverAAsistencia()">‚Üê Volver a evaluaci√≥n de asistencia</button>
  <div id="mensajeExito" class="success"></div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBlRbAQZVSWSZgNw8w4Iie7WsdSdogRX5o",
    authDomain: "formularioobra.firebaseapp.com",
    projectId: "formularioobra",
    storageBucket: "formularioobra.firebasestorage.app",
    messagingSenderId: "483554481916",
    appId: "1:483554481916:web:c2b175955247a1b6f56979"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variables globales
  let ResponsableRegistro = "";
  let SucursalSeleccionada = "";
  let ProyectoSeleccionado = "";
  let NombreResponsable = "";
  let ProyectoTemporal = "";
  let TipoReunionSeleccionado = "";
  let AsistenciaCalculada = 0;
  let ContratistasSemanal = []; // Para almacenar los contratistas en reuni√≥n semanal

  // Base de datos de proyectos con sucursal
  const proyectosConSucursal = [
    { nombre: "Scala", sucursal: "Bogot√°" },
    { nombre: "Almeria", sucursal: "Bogot√°" },
    { nombre: "Chamonix", sucursal: "Bogot√°" },
    { nombre: "Gallet", sucursal: "Bogot√°" },
    { nombre: "Aquaris", sucursal: "Costa" },
    { nombre: "Quarus", sucursal: "Costa" }
  ];

  // Mapeo de proyectos por sucursal
  const proyectosPorSucursal = {
    "Direcci√≥n Nacional": ["Scala", "Almeria", "Chamonix", "Gallet", "Aquaris", "Quarus"],
    "Sucursal Bogot√°": ["Scala", "Almeria", "Chamonix", "Gallet"],
    "Sucursal Bucaramanga": ["Scala", "Almeria", "Chamonix", "Gallet"],
    "Sucursal Costa": ["Aquaris", "Quarus"]
  };

  // Nombres completos de responsables
  const nombresResponsables = {
    "Direcci√≥n Nacional": "Ing. Juan Romero - Direcci√≥n Nacional",
    "Sucursal Bogot√°": "Ing. Camilo Pulgarin - Sucursal Bogot√°",
    "Sucursal Bucaramanga": "Ing. Paola Ramirez - Sucursal Bucaramanga",
    "Sucursal Costa": "Ing. Daniela Herrera - Sucursal Costa"
  };

  // Contratistas por proyecto (ejemplo - en producci√≥n esto vendr√≠a de BD)
  const contratistasPorProyecto = {
    "Scala": ["Contratista A", "Contratista B", "Contratista C"],
    "Almeria": ["Contratista X", "Contratista Y"],
    "Chamonix": ["Contratista 1", "Contratista 2", "Contratista 3"],
    "Gallet": ["Contratista Alpha", "Contratista Beta"],
    "Aquaris": ["Contratista Costa 1", "Contratista Costa 2"],
    "Quarus": ["Contratista Quarus 1"]
  };

  // Ocultar splash inicial despu√©s de 1.5 segundos y mostrar splash principal
  setTimeout(function() {
    document.getElementById("splashInicial").style.display = "none";
    document.getElementById("splash").classList.add("active");
  }, 1500);

  function mostrarResponsables() {
    document.getElementById("splash").classList.remove("active");
    document.getElementById("responsables").classList.add("active");
  }

  function seleccionarResponsable(sucursal) {
    SucursalSeleccionada = sucursal;
    NombreResponsable = nombresResponsables[sucursal];
    ResponsableRegistro = NombreResponsable;

    document.getElementById("responsables").classList.remove("active");
    document.getElementById("proyectosScreen").classList.add("active");
    
    // Mostrar mensaje de bienvenida
    document.getElementById("bienvenidaResponsable").innerText = `Bienvenido, ${NombreResponsable}`;
    
    // Limpiar b√∫squeda y proyecto temporal
    document.getElementById("buscadorProyectos").value = "";
    ProyectoTemporal = "";
    document.getElementById("proyectoSeleccionadoContainer").style.display = "none";
    
    // Mostrar proyectos seg√∫n sucursal
    mostrarProyectos(sucursal);
  }

  function mostrarProyectos(sucursal) {
    const listaProyectos = document.getElementById("listaProyectos");
    const proyectosPermitidos = proyectosPorSucursal[sucursal];
    
    // Filtrar proyectos por los permitidos para esta sucursal
    const proyectosAFiltrar = proyectosConSucursal.filter(proyecto => 
      proyectosPermitidos.includes(proyecto.nombre)
    );
    
    listaProyectos.innerHTML = "";
    
    if (proyectosAFiltrar.length === 0) {
      listaProyectos.innerHTML = '<div class="no-results">No hay proyectos disponibles para esta sucursal</div>';
      return;
    }
    
    proyectosAFiltrar.forEach(proyecto => {
      const card = document.createElement("div");
      card.className = "project-card";
      card.setAttribute("data-proyecto", proyecto.nombre);
      
      card.innerHTML = `
        <div class="project-name">${proyecto.nombre}</div>
        <div class="project-sucursal">Sucursal: ${proyecto.sucursal}</div>
      `;
      
      card.onclick = function() {
        seleccionarProyectoCard(proyecto.nombre);
      };
      
      listaProyectos.appendChild(card);
    });
  }

  function seleccionarProyectoCard(proyecto) {
    // Deseleccionar todas las tarjetas
    const todasLasTarjetas = document.querySelectorAll('.project-card');
    todasLasTarjetas.forEach(card => {
      card.classList.remove('selected');
    });
    
    // Seleccionar la tarjeta clickeada
    const tarjetaSeleccionada = document.querySelector(`[data-proyecto="${proyecto}"]`);
    if (tarjetaSeleccionada) {
      tarjetaSeleccionada.classList.add('selected');
    }
    
    // Guardar proyecto temporalmente
    ProyectoTemporal = proyecto;
    
    // Mostrar bot√≥n de seleccionar
    document.getElementById("proyectoSeleccionadoContainer").style.display = "block";
  }

  function confirmarProyecto() {
    if (!ProyectoTemporal) {
      alert("Por favor, seleccione un proyecto primero");
      return;
    }
    
    ProyectoSeleccionado = ProyectoTemporal;
    
    // Ir a pantalla de selecci√≥n de tipo de reuni√≥n
    document.getElementById("proyectosScreen").classList.remove("active");
    document.getElementById("tipoReunionScreen").classList.add("active");
    
    // Actualizar informaci√≥n en pantalla de tipo de reuni√≥n
    document.getElementById("bienvenidaTipoReunion").innerText = `Bienvenido, ${NombreResponsable}`;
    document.getElementById("infoProyectoTipoReunion").innerText = `Proyecto: ${ProyectoSeleccionado}`;
  }

  function seleccionarTipoReunion(tipoReunion) {
    TipoReunionSeleccionado = tipoReunion;
    
    // Obtener contratistas para este proyecto si es reuni√≥n semanal
    if (tipoReunion === "Semanal - Contratistas y Obra") {
      ContratistasSemanal = contratistasPorProyecto[ProyectoSeleccionado] || [];
    } else {
      ContratistasSemanal = [];
    }
    
    // Ir a pantalla de evaluaci√≥n de asistencia
    document.getElementById("tipoReunionScreen").classList.remove("active");
    document.getElementById("asistenciaScreen").classList.add("active");
    
    // Configurar pantalla de asistencia seg√∫n el tipo de reuni√≥n
    configurarPantallaAsistencia();
  }

  function configurarPantallaAsistencia() {
    const contenedor = document.getElementById("contenedorAsistencia");
    const titulo = document.getElementById("tituloAsistencia");
    const subtitulo = document.getElementById("subtituloAsistencia");
    
    titulo.innerText = `Evaluaci√≥n de Asistencia`;
    subtitulo.innerText = `Proyecto: ${ProyectoSeleccionado} | ${TipoReunionSeleccionado}`;
    
    if (TipoReunionSeleccionado === "Intermedia - Equipo Administrativo") {
      configurarAsistenciaIntermedia(contenedor);
    } else if (TipoReunionSeleccionado === "Semanal - Contratistas y Obra") {
      configurarAsistenciaSemanal(contenedor);
    }
  }

  function configurarAsistenciaIntermedia(contenedor) {
    const participantes = [
      { id: 'director', nombre: 'Director', peso: 25, asistio: false },
      { id: 'residente1', nombre: 'Residente 1', peso: 5, asistio: false },
      { id: 'residente2', nombre: 'Residente 2', peso: 5, asistio: false },
      { id: 'residente3', nombre: 'Residente 3', peso: 5, asistio: false },
      { id: 'residente4', nombre: 'Residente 4', peso: 5, asistio: false },
      { id: 'residente5', nombre: 'Residente 5', peso: 5, asistio: false },
      { id: 'fca', nombre: 'FCA', peso: 10, asistio: false },
      { id: 'syst', nombre: 'SYST', peso: 10, asistio: false },
      { id: 'logistico', nombre: 'Log√≠stico', peso: 10, asistio: false },
      { id: 'programador', nombre: 'Programador', peso: 20, asistio: false }
    ];
    
    let html = `
      <div class="tipo-reunion-info">
        <h3>üè¢ Reuni√≥n Intermedia - Equipo Administrativo</h3>
        <p>Marque la asistencia de cada participante. Los pesos suman 100%.</p>
      </div>
    `;
    
    participantes.forEach(participante => {
      html += `
        <div class="participante-item">
          <div class="participante-info">
            <div class="participante-nombre">${participante.nombre}</div>
            <div class="participante-peso">Peso: ${participante.peso}%</div>
          </div>
          <div class="asistencia-control">
            <input type="checkbox" 
                   class="asistencia-checkbox" 
                   id="${participante.id}"
                   data-peso="${participante.peso}"
                   onchange="calcularAsistencia()">
            <label for="${participante.id}">Asisti√≥</label>
          </div>
        </div>
      `;
    });
    
    html += `
      <div class="total-asistencia">
        <div>Asistencia Total</div>
        <div class="total-porcentaje" id="totalPorcentaje">0%</div>
        <div id="notaAsistencia"></div>
      </div>
    `;
    
    contenedor.innerHTML = html;
    // Inicializar c√°lculo
    calcularAsistencia();
  }

  function configurarAsistenciaSemanal(contenedor) {
    // Obtener contratistas del proyecto
    const contratistas = ContratistasSemanal;
    
    let html = `
      <div class="tipo-reunion-info">
        <h3>üìã Reuni√≥n Semanal - Contratistas y Obra</h3>
        <p>Validaci√≥n especial: El Director debe verificar asistencia de todos los contratistas.</p>
        <p class="nota-info">Nota: Si falta alg√∫n contratista, la nota del Director se reduce a la mitad.</p>
      </div>
      
      <div class="participante-item" style="background-color: #fff3e0;">
        <div class="participante-info">
          <div class="participante-nombre">Director</div>
          <div class="participante-peso">Peso: 30% (con validaci√≥n de contratistas)</div>
        </div>
        <div class="asistencia-control">
          <input type="checkbox" 
                 class="asistencia-checkbox" 
                 id="director"
                 data-peso="30"
                 data-validar-contratistas="true"
                 onchange="calcularAsistencia()">
          <label for="director">Asisti√≥</label>
        </div>
      </div>
    `;
    
    // Mostrar lista de contratistas si existen
    if (contratistas.length > 0) {
      html += `
        <div class="contratistas-container">
          <h4>Contratistas en el proyecto (${contratistas.length})</h4>
          <p>El Director debe validar la asistencia de cada contratista:</p>
      `;
      
      contratistas.forEach((contratista, index) => {
        html += `
          <div class="contratista-item">
            <span>${contratista}</span>
            <div>
              <input type="checkbox" 
                     class="contratista-checkbox" 
                     id="contratista-${index}"
                     onchange="validarContratistas()">
              <label for="contratista-${index}">Presente</label>
            </div>
          </div>
        `;
      });
      
      html += `</div>`;
    } else {
      html += `
        <div class="contratistas-container">
          <p>No hay contratistas registrados para este proyecto.</p>
          <p class="nota-info">Se asume que todos los contratistas est√°n presentes.</p>
        </div>
      `;
    }
    
    // Resto de participantes
    const otrosParticipantes = [
      { id: 'residentes', nombre: 'Residentes (todos)', peso: 30 },
      { id: 'syst', nombre: 'SYST', peso: 20 },
      { id: 'logistico', nombre: 'Log√≠stico', peso: 20 }
    ];
    
    otrosParticipantes.forEach(participante => {
      html += `
        <div class="participante-item">
          <div class="participante-info">
            <div class="participante-nombre">${participante.nombre}</div>
            <div class="participante-peso">Peso: ${participante.peso}%</div>
          </div>
          <div class="asistencia-control">
            <input type="checkbox" 
                   class="asistencia-checkbox" 
                   id="${participante.id}"
                   data-peso="${participante.peso}"
                   onchange="calcularAsistencia()">
            <label for="${participante.id}">Asisti√≥</label>
          </div>
        </div>
      `;
    });
    
    html += `
      <div class="total-asistencia">
        <div>Asistencia Total</div>
        <div class="total-porcentaje" id="totalPorcentaje">0%</div>
        <div id="notaAsistencia"></div>
      </div>
    `;
    
    contenedor.innerHTML = html;
    // Inicializar c√°lculo
    calcularAsistencia();
  }

  function calcularAsistencia() {
    const checkboxes = document.querySelectorAll('.asistencia-checkbox');
    let total = 0;
    let directorCheckbox = null;
    let todosContratistasPresentes = true;
    
    // Validar contratistas si es reuni√≥n semanal
    if (TipoReunionSeleccionado === "Semanal - Contratistas y Obra") {
      const contratistasCheckboxes = document.querySelectorAll('.contratista-checkbox');
      directorCheckbox = document.getElementById('director');
      
      if (contratistasCheckboxes.length > 0) {
        todosContratistasPresentes = true;
        contratistasCheckboxes.forEach(cb => {
          if (!cb.checked) {
            todosContratistasPresentes = false;
          }
        });
      }
    }
    
    // Calcular total
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        let peso = parseInt(checkbox.getAttribute('data-peso'));
        
        // Validaci√≥n especial para director en reuni√≥n semanal
        if (checkbox.id === 'director' && checkbox.getAttribute('data-validar-contratistas')) {
          if (!todosContratistasPresentes) {
            peso = peso / 2; // Reducir a la mitad si faltan contratistas
          }
        }
        
        total += peso;
      }
    });
    
    // Actualizar display
    document.getElementById('totalPorcentaje').innerText = `${total}%`;
    
    let notaTexto = "";
    if (TipoReunionSeleccionado === "Semanal - Contratistas y Obra" && directorCheckbox && directorCheckbox.checked) {
      if (!todosContratistasPresentes) {
        notaTexto = "‚ö†Ô∏è Nota: Director con peso reducido (faltan contratistas)";
      } else {
        notaTexto = "‚úì Todos los contratistas presentes";
      }
    }
    document.getElementById('notaAsistencia').innerHTML = notaTexto;
    
    // Guardar asistencia calculada y habilitar bot√≥n de continuar
    AsistenciaCalculada = total;
    document.getElementById('btnContinuarAsistencia').disabled = total === 0;
    
    return total;
  }

  function validarContratistas() {
    // Recalcular cuando cambia la asistencia de contratistas
    calcularAsistencia();
  }

  function continuarAFormulario() {
    document.getElementById("asistenciaScreen").classList.remove("active");
    document.getElementById("formularioScreen").classList.add("active");
    
    // Actualizar informaci√≥n en el formulario
    document.getElementById("bienvenidaCompleta").innerText = `Bienvenido, ${NombreResponsable}`;
    document.getElementById("infoProyecto").innerText = `Proyecto: ${ProyectoSeleccionado} | ${TipoReunionSeleccionado}`;
    
    // Establecer valores pre-seleccionados
    const proyectoOption = document.getElementById("proyectoSeleccionadoOption");
    proyectoOption.value = ProyectoSeleccionado;
    proyectoOption.textContent = ProyectoSeleccionado;
    document.getElementById("proyectoSelect").value = ProyectoSeleccionado;
    
    const tipoReunionOption = document.getElementById("tipoReunionSeleccionadaOption");
    tipoReunionOption.value = TipoReunionSeleccionado;
    tipoReunionOption.textContent = TipoReunionSeleccionado;
    document.getElementById("tipoReunionSelect").value = TipoReunionSeleccionado;
    
    // Mostrar asistencia calculada
    document.getElementById("as
