<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Auditor√≠a Lean Construction</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #ffffff;
      color: #1d1d1f;
      text-align: center;
    }

    /* SPLASH INICIAL */
    #splashInicial {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #0f4c75, #3282b8, #bbe1fa);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      z-index: 1000;
    }

    #splashInicial h1 {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    #splashInicial .empresa {
      font-size: 24px;
      font-weight: 400;
      margin-bottom: 30px;
      opacity: 0.9;
    }

    #splashInicial .version {
      position: absolute;
      bottom: 30px;
      font-size: 14px;
      opacity: 0.9;
      color: rgba(255, 255, 255, 0.9);
    }

    .screen {
      display: none;
      min-height: 100vh;
      padding: 60px 20px;
      box-sizing: border-box;
    }

    .active {
      display: block;
    }

    h1 {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    h2 {
      font-size: 22px;
      font-weight: 400;
      color: #6e6e73;
      margin-bottom: 40px;
    }

    button {
      background-color: #0071e3;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 24px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #005bb5;
    }

    button.secondary {
      background-color: #e5e5ea;
      color: #000;
    }

    button.secondary:hover {
      background-color: #d1d1d6;
    }

    form {
      max-width: 600px;
      margin: auto;
      text-align: left;
    }

    label {
      font-weight: 500;
      display: block;
      margin-top: 20px;
    }

    select {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #d2d2d7;
      font-size: 15px;
    }

    .success {
      color: #0071e3;
      font-size: 18px;
      margin-top: 20px;
    }

    .back-button {
      background-color: #e5e5ea;
      color: #000;
      margin-bottom: 30px;
    }

    .back-button:hover {
      background-color: #d1d1d6;
    }

    /* ESTILOS PARA LA B√öSQUEDA DE PROYECTOS */
    .search-container {
      max-width: 600px;
      margin: 0 auto 30px auto;
    }

    .search-input {
      width: 100%;
      padding: 14px 20px;
      border-radius: 10px;
      border: 1px solid #d2d2d7;
      font-size: 16px;
      box-sizing: border-box;
    }

    .search-input:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    /* ESTILOS PARA LAS TARJETAS DE PROYECTOS */
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: 0 auto 40px auto;
    }

    .project-card {
      background-color: #f5f5f7;
      border-radius: 12px;
      padding: 25px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .project-card:hover {
      background-color: #e8e8ed;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .project-card.selected {
      background-color: #0071e3;
      color: white;
      border-color: #005bb5;
    }

    .project-card.hidden {
      display: none;
    }

    .project-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .project-sucursal {
      font-size: 14px;
      color: #666;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 4px 10px;
      border-radius: 20px;
      display: inline-block;
      margin-top: 5px;
    }

    .project-card.selected .project-sucursal {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .no-results {
      grid-column: 1 / -1;
      padding: 40px;
      color: #666;
      font-size: 18px;
    }

    .select-button {
      margin-top: 20px;
      width: auto;
      min-width: 200px;
    }
  </style>
</head>

<body>

<!-- SPLASH INICIAL (Nuevo) -->
<div id="splashInicial">
  <h1>Madurez Lean Construction</h1>
  <div class="empresa">MARVAL S.A.</div>
  <div class="version">Formulario Lean Versi√≥n 1.1</div>
</div>

<!-- SPLASH (Original) -->
<div id="splash" class="screen">
  <h1>Auditor√≠a Lean Construction</h1>
  <h2>Evaluaci√≥n del nivel de madurez en obra</h2>
  <button onclick="mostrarResponsables()">Iniciar auditor√≠a</button>
</div>

<!-- SELECCI√ìN RESPONSABLE -->
<div id="responsables" class="screen">
  <h1>Seleccione el responsable</h1>

  <button onclick="seleccionarResponsable('Direcci√≥n Nacional')">
    Direcci√≥n Nacional
  </button>

  <button onclick="seleccionarResponsable('Sucursal Bogot√°')">
    Sucursal Bogot√°
  </button>

  <button onclick="seleccionarResponsable('Sucursal Bucaramanga')">
    Sucursal Bucaramanga
  </button>

  <button onclick="seleccionarResponsable('Sucursal Costa')">
    Sucursal Costa
  </button>
</div>

<!-- SELECCI√ìN DE PROYECTO -->
<div id="proyectosScreen" class="screen">
  <h1 id="bienvenidaResponsable"></h1>
  <h2>Seleccione el proyecto a auditar</h2>
  
  <div class="search-container">
    <input type="text" 
           id="buscadorProyectos" 
           class="search-input" 
           placeholder="üîç Buscar proyecto por nombre..."
           onkeyup="filtrarProyectos()">
  </div>
  
  <div class="projects-grid" id="listaProyectos"></div>
  
  <div id="proyectoSeleccionadoContainer" style="display: none;">
    <button class="select-button" onclick="confirmarProyecto()">Seleccionar Proyecto</button>
  </div>
  
  <button class="back-button" onclick="volverAResponsables()">‚Üê Volver a selecci√≥n de responsable</button>
</div>

<!-- FORMULARIO COMPLETO -->
<div id="formularioScreen" class="screen">
  <h1 id="bienvenidaCompleta"></h1>
  <h2 id="infoProyecto"></h2>

  <form id="formAuditoria">
    <label>Proyecto seleccionado</label>
    <select name="proyecto" id="proyectoSelect" required disabled>
      <option value="" id="proyectoSeleccionadoOption"></option>
    </select>

    <label>Tipo de reuni√≥n evaluada</label>
    <select name="tipoReunion" required>
      <option value="">Seleccione una opci√≥n</option>
      <option value="Intermedia - Equipo Administrativo">
        Intermedia (Equipo Administrativo)
      </option>
      <option value="Semanal - Contratistas y Obra">
        Semanal (Contratistas / Directores / Residentes)
      </option>
    </select>

    <label>Nivel de cumplimiento Lean observado</label>
    <select name="nivelMadurez" required>
      <option value="">Seleccione una opci√≥n</option>
      <option value="Inicial">Inicial</option>
      <option value="En desarrollo">En desarrollo</option>
      <option value="Estandarizado">Estandarizado</option>
      <option value="Optimizado">Optimizado</option>
    </select>

    <label>Observaciones adicionales (opcional)</label>
    <textarea name="observaciones" rows="3" placeholder="Agregue observaciones relevantes sobre la auditor√≠a" style="width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #d2d2d7; font-size: 15px; font-family: inherit;"></textarea>

    <button type="submit" style="margin-top:30px;">Guardar auditor√≠a</button>
  </form>

  <button class="back-button" onclick="volverAProyectos()">‚Üê Volver a selecci√≥n de proyecto</button>
  <div id="mensajeExito" class="success"></div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBlRbAQZVSWSZgNw8w4Iie7WsdSdogRX5o",
    authDomain: "formularioobra.firebaseapp.com",
    projectId: "formularioobra",
    storageBucket: "formularioobra.firebasestorage.app",
    messagingSenderId: "483554481916",
    appId: "1:483554481916:web:c2b175955247a1b6f56979"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variables globales
  let ResponsableRegistro = "";
  let SucursalSeleccionada = "";
  let ProyectoSeleccionado = "";
  let NombreResponsable = "";
  let ProyectoTemporal = "";

  // Base de datos de proyectos con sucursal
  const proyectosConSucursal = [
    { nombre: "Scala", sucursal: "Bogot√°" },
    { nombre: "Almeria", sucursal: "Bogot√°" },
    { nombre: "Chamonix", sucursal: "Bogot√°" },
    { nombre: "Gallet", sucursal: "Bogot√°" },
    { nombre: "Aquaris", sucursal: "Costa" },
    { nombre: "Quarus", sucursal: "Costa" }
  ];

  // Mapeo de proyectos por sucursal
  const proyectosPorSucursal = {
    "Direcci√≥n Nacional": ["Scala", "Almeria", "Chamonix", "Gallet", "Aquaris", "Quarus"],
    "Sucursal Bogot√°": ["Scala", "Almeria", "Chamonix", "Gallet"],
    "Sucursal Bucaramanga": ["Scala", "Almeria", "Chamonix", "Gallet"],
    "Sucursal Costa": ["Aquaris", "Quarus"]
  };

  // Nombres completos de responsables
  const nombresResponsables = {
    "Direcci√≥n Nacional": "Ing. Juan Romero - Direcci√≥n Nacional",
    "Sucursal Bogot√°": "Ing. Camilo Pulgarin - Sucursal Bogot√°",
    "Sucursal Bucaramanga": "Ing. Paola Ramirez - Sucursal Bucaramanga",
    "Sucursal Costa": "Ing. Daniela Herrera - Sucursal Costa"
  };

  // Ocultar splash inicial despu√©s de 1.5 segundos y mostrar splash principal
  setTimeout(function() {
    document.getElementById("splashInicial").style.display = "none";
    document.getElementById("splash").classList.add("active");
  }, 1500);

  function mostrarResponsables() {
    document.getElementById("splash").classList.remove("active");
    document.getElementById("responsables").classList.add("active");
  }

  function seleccionarResponsable(sucursal) {
    SucursalSeleccionada = sucursal;
    NombreResponsable = nombresResponsables[sucursal];
    ResponsableRegistro = NombreResponsable;

    document.getElementById("responsables").classList.remove("active");
    document.getElementById("proyectosScreen").classList.add("active");
    
    // Mostrar mensaje de bienvenida
    document.getElementById("bienvenidaResponsable").innerText = `Bienvenido, ${NombreResponsable}`;
    
    // Limpiar b√∫squeda y proyecto temporal
    document.getElementById("buscadorProyectos").value = "";
    ProyectoTemporal = "";
    document.getElementById("proyectoSeleccionadoContainer").style.display = "none";
    
    // Mostrar proyectos seg√∫n sucursal
    mostrarProyectos(sucursal);
  }

  function mostrarProyectos(sucursal) {
    const listaProyectos = document.getElementById("listaProyectos");
    const proyectosPermitidos = proyectosPorSucursal[sucursal];
    
    // Filtrar proyectos por los permitidos para esta sucursal
    const proyectosAFiltrar = proyectosConSucursal.filter(proyecto => 
      proyectosPermitidos.includes(proyecto.nombre)
    );
    
    listaProyectos.innerHTML = "";
    
    if (proyectosAFiltrar.length === 0) {
      listaProyectos.innerHTML = '<div class="no-results">No hay proyectos disponibles para esta sucursal</div>';
      return;
    }
    
    proyectosAFiltrar.forEach(proyecto => {
      const card = document.createElement("div");
      card.className = "project-card";
      card.setAttribute("data-proyecto", proyecto.nombre);
      
      card.innerHTML = `
        <div class="project-name">${proyecto.nombre}</div>
        <div class="project-sucursal">Sucursal: ${proyecto.sucursal}</div>
      `;
      
      card.onclick = function() {
        seleccionarProyectoCard(proyecto.nombre);
      };
      
      listaProyectos.appendChild(card);
    });
  }

  function seleccionarProyectoCard(proyecto) {
    // Deseleccionar todas las tarjetas
    const todasLasTarjetas = document.querySelectorAll('.project-card');
    todasLasTarjetas.forEach(card => {
      card.classList.remove('selected');
    });
    
    // Seleccionar la tarjeta clickeada
    const tarjetaSeleccionada = document.querySelector(`[data-proyecto="${proyecto}"]`);
    if (tarjetaSeleccionada) {
      tarjetaSeleccionada.classList.add('selected');
    }
    
    // Guardar proyecto temporalmente
    ProyectoTemporal = proyecto;
    
    // Mostrar bot√≥n de seleccionar
    document.getElementById("proyectoSeleccionadoContainer").style.display = "block";
  }

  function confirmarProyecto() {
    if (!ProyectoTemporal) {
      alert("Por favor, seleccione un proyecto primero");
      return;
    }
    
    ProyectoSeleccionado = ProyectoTemporal;
    
    document.getElementById("proyectosScreen").classList.remove("active");
    document.getElementById("formularioScreen").classList.add("active");
    
    // Actualizar informaci√≥n en el formulario
    document.getElementById("bienvenidaCompleta").innerText = `Bienvenido, ${NombreResponsable}`;
    document.getElementById("infoProyecto").innerText = `Proyecto: ${ProyectoSeleccionado}`;
    
    // Establecer el proyecto seleccionado en el select
    const proyectoOption = document.getElementById("proyectoSeleccionadoOption");
    proyectoOption.value = ProyectoSeleccionado;
    proyectoOption.textContent = ProyectoSeleccionado;
    document.getElementById("proyectoSelect").value = ProyectoSeleccionado;
  }

  function filtrarProyectos() {
    const busqueda = document.getElementById("buscadorProyectos").value.toLowerCase();
    const proyectosPermitidos = proyectosPorSucursal[SucursalSeleccionada];
    
    // Filtrar proyectos por los permitidos para esta sucursal
    const proyectosAFiltrar = proyectosConSucursal.filter(proyecto => 
      proyectosPermitidos.includes(proyecto.nombre)
    );
    
    // Filtrar por b√∫squeda
    const proyectosFiltrados = proyectosAFiltrar.filter(proyecto => 
      proyecto.nombre.toLowerCase().includes(busqueda)
    );
    
    // Obtener todas las tarjetas actuales
    const todasLasTarjetas = document.querySelectorAll('.project-card');
    
    if (busqueda === "") {
      // Si no hay b√∫squeda, mostrar todas las tarjetas
      todasLasTarjetas.forEach(card => {
        card.classList.remove('hidden');
      });
    } else {
      // Si hay b√∫squeda, ocultar las que no coinciden
      todasLasTarjetas.forEach(card => {
        const nombreProyecto = card.getAttribute("data-proyecto").toLowerCase();
        if (nombreProyecto.includes(busqueda)) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
    }
    
    // Mostrar mensaje si no hay resultados
    const noResults = document.querySelector('.no-results');
    if (proyectosFiltrados.length === 0 && busqueda !== "") {
      if (!noResults) {
        const listaProyectos = document.getElementById("listaProyectos");
        const mensaje = document.createElement("div");
        mensaje.className = "no-results";
        mensaje.textContent = "No se encontraron proyectos que coincidan con la b√∫squeda";
        listaProyectos.appendChild(mensaje);
      }
    } else if (noResults) {
      noResults.remove();
    }
  }

  function volverAResponsables() {
    document.getElementById("proyectosScreen").classList.remove("active");
    document.getElementById("responsables").classList.add("active");
  }

  function volverAProyectos() {
    document.getElementById("formularioScreen").classList.remove("active");
    document.getElementById("proyectosScreen").classList.add("active");
  }

  document.getElementById("formAuditoria").addEventListener("submit", function(e) {
    e.preventDefault();

    const proyecto = this.proyecto.value;
    const tipoReunion = this.tipoReunion.value;
    const nivelMadurez = this.nivelMadurez.value;
    const observaciones = this.observaciones.value || "";

    db.collection("auditoriasLean").add({
      ResponsableRegistro: ResponsableRegistro,
      Sucursal: SucursalSeleccionada,
      Proyecto: proyecto,
      TipoReunion: tipoReunion,
      NivelMadurez: nivelMadurez,
      Observaciones: observaciones,
      FechaRegistro: new Date()
    })
    .then(() => {
      document.getElementById("mensajeExito").innerText = "Auditor√≠a registrada correctamente.";
      
      // Limpiar formulario pero mantener proyecto seleccionado
      this.tipoReunion.value = "";
      this.nivelMadurez.value = "";
      this.observaciones.value = "";
      
      // Ocultar mensaje despu√©s de 3 segundos
      setTimeout(() => {
        document.getElementById("mensajeExito").innerText = "";
      }, 3000);
    })
    .catch(error => {
      alert("Error al guardar: " + error);
    });
  });
</script>

</body>
</html>
